# 第 5 章 · 5.1  音符拼接的字符乐章【存储模型】

> 场景：午后音乐教室，柔光透过百叶窗，琴弦与字符共振。
> 角色：安妮、黛芙、伊莎贝尔、希娅
> 目标：通过可视化比喻理解『串的存储模型、字符编码、不可变与可变』。

---

## §0 动画分镜
1. 镜头缓缓推进――阳光在木地板上映出五线谱状光带。
2. 安妮抱着粉色尤克里里，小跑进教室，谱纸哗啦落地，散成字符一般的音符卡片。
3. 黛芙走来弯腰拾起一张 ♩，两人的指尖短暂相触，镜头轻微摇晃，定格在二人含笑的眼神上。

---

## §1 日常冲突 · 『乱码』危机
* 彩色 LED 歌词投影忽然全变成 "Ã¦ÂÂ¯..." 的乱码。
* 安妮慌张："明明复制的是《樱之记忆》的歌词啊！"
* 伊莎贝尔检查设备："编码不统一，UTF-8 和 GBK 打架了。"
* 讨论引出：字符 = 数字；不同编码 = 不同映射表 → **存储模型话题开启**。

---

## §2 糖果实验 · 可视化演示
| 道具 | 类比 |
|------|------|
| 五线谱格纸 | 字符数组连续内存 |
| 彩色音符贴纸 | 字符（1 字节 / 多字节） |
| 白色胶带 | '0' 结束符 |

1. **单字节编码**：ASCII —— 一格放一贴纸，英文歌《ABC》演示。
2. **多字节编码**：UTF-8 —— "樱"字需要 3 枚贴纸按序排入 3 格。
3. 安妮用胶带在最后一格粘一个 "END" 旗子，说明空字符终止，便于遍历。
4. 黛芙把两张五线谱纸对齐，用回形夹连在一起：演示『不可变字符串拼接 = 新开区域 + 复制』。

> 彩蛋二维码：扫码观看字符贴纸动画（附在线 demo）。

---

## §3 算法拆解 · 技术讲解
### 1. 字符串的两种主流存储
* **定长数组**（C/C++ char a[N]）
  * 末尾 `0` 结束；操作需注意边界
  * 申请在栈/堆，访问 O(1)
* **动态对象**（Java String / Python str）
  * 不可变；底层仍是字符数组
  * 拼接等价 `new_array = old + new` 时间 O(n)

### 2. 编码与字节
* ASCII：1B；UTF-8：1–4B；UTF-16：2B/4B
* 【示例】'A' → 0x41；'樱' → 0xE6 0xA8 0xBA

### 3. 常见坑
| 坑点 | 场景 | 解决 |
|---|---|---|
| 编码不一致 | 数据库/文件 | 统一 UTF-8 |
| 拼接频繁耗时 | 日志生成 | 使用 `StringBuilder` / `list.append`|
| 缓冲溢出 | C gets() | 换 fgets/scanf+长度 |

---

## §4 角色情感 & 成长
* 黛芙轻声教安妮："字符也是音符，有自己的节拍。"
* 安妮恍然，快乐地点头，重新把投影编码改为 UTF-8，歌词恢复。
* 希娅用手指在琴弦打节拍，伊莎贝尔递上用 UTF-16 打印的和弦表，两人相视一笑："备份方案就绪。"
* 短暂静默后，黛芙在安妮耳边补充："下次出问题，先别慌，记得看编码。" 安妮脸微红，却用力点头。

---

## §5 知识小厨 · 小结 & 练习
### 本节要点
1. 串 = 字节序列 + 编码表
2. '0' 结束符 vs 显式长度
3. 不可变拼接 = 申请新空间 → O(n)

### 常见误区
- 忘记留 '0' → 未定义行为
- UTF-8 与本地编码混用 → 乱码
- 高频拼接用 `+` → N² 拖慢性能

### LeetCode 预热
1. 344. 反转字符串（双指针）
2. 557. 反转字符串中的单词 III
3. 125. 验证回文串

> 完成本节 commit：`git commit -m "ch5.1 string-storage"`

---

🎵 **下一节 5.2《歌词剪贴的花式拼盘》将把目光移向 substr / concat / 查找，让音符真正流动起来！** 